<?xml version="1.0" encoding="UTF-8"?>
<template xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2018.1/project-config.xsd">
  <name>Add files from XDocs to Bitbucket template</name>
  <settings>
    <options>
      <option name="cleanBuild" value="true" />
      <option name="maximumNumberOfBuilds" value="1" />
    </options>
    <parameters>
      <param name="env.EXPORT_PATH_IDS" value="%EXPORT_PATH_IDS%" spec="text validationMode='not_empty'" />
      <param name="env.SOURCES_ROOT" value="%SOURCES_ROOT%" spec="text label='Git clone directory' description='Directory for the repo cloned from Bitbucket' display='hidden' validationMode='not_empty'" />
      <param name="env.XDOCS_EXPORT_DIR" value="%XDOCS_EXPORT_DIR%" spec="text validationMode='not_empty'" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_2621" name="Export files from XDocs" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[chmod 777 runExport.sh
for path in %env.EXPORT_PATH_IDS%; do ./runExport.sh "$path" %env.XDOCS_EXPORT_DIR%; done]]></param>
          <param name="teamcity.build.workingDir" value="LocalClient/sample/local/bin" />
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_2622" name="Add exported files to Bitbucket" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[set -xe
git config --global user.email "doctools@guidewire.com"
git config --global user.name "%serviceAccountUsername%"
cp -R %env.XDOCS_EXPORT_DIR%/* %env.SOURCES_ROOT%/
cd %env.SOURCES_ROOT%
git add -A
if git status | grep "Changes to be committed"
then
  git commit -m "[TeamCity] Adds files exported from XDocs"
  git push origin master
else
  echo "No changes to commit"
fi]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="DocumentationTools_XDocsClient" />
    </vcs-settings>
    <requirements />
    <build-triggers />
    <build-extensions>
      <extension id="ssh-agent-build-feature" type="ssh-agent-build-feature">
        <parameters>
          <param name="teamcitySshKey" value="sys-doc.rsa" />
        </parameters>
      </extension>
    </build-extensions>
    <cleanup />
  </settings>
</template>

