<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2018.1/project-config.xsd">
  <name>Deploy to Prod</name>
  <description />
  <settings ref="DocumentationTools_DocumentationPortal_Deploy">
    <options>
      <option name="cleanBuild" value="true" />
    </options>
    <parameters>
      <param name="env.AWS_ACCESS_KEY_ID" value="%env.ATMOS_PROD_AWS_ACCESS_KEY_ID%" />
      <param name="env.AWS_DEFAULT_REGION" value="%env.ATMOS_PROD_AWS_DEFAULT_REGION%" />
      <param name="env.AWS_SECRET_ACCESS_KEY" value="%env.ATMOS_PROD_AWS_SECRET_ACCESS_KEY%" />
      <param name="env.CUSTOMERS_LOGIN_URL" value="https://community.guidewire.com/idp/endpoint/HttpRedirect" />
      <param name="env.DEPLOY_ENV" value="us-east-2" />
      <param name="env.NAMESPACE" value="doctools" spec="text label='Namespace' display='prompt' validationMode='not_empty'" />
      <param name="env.PARTNERS_LOGIN_URL" value="https://partner.guidewire.com/idp/endpoint/HttpRedirect" />
      <param name="env.TAG_VERSION" value="" spec="text label='Deploy Version' display='prompt' validationMode='regex' regexp='^(|[0-9|]+\.|[0-9|]+\.|[0-9|]+)$' validationMessage='Invalid SemVer Format'" />
    </parameters>
    <build-runners order="PUSH_TO_ECR, DEPLOY_TO_K8S, CHECK_PODS_STATUS, ACCEPTANCE_TESTS">
      <runner id="PUSH_TO_ECR" name="Push Docker Image to ECR" type="simpleRunner">
        <parameters>
          <param name="plugin.docker.imageId" value="artifactory.guidewire.com/devex-docker-dev/atmosdeploy:0.12.24" />
          <param name="plugin.docker.imagePlatform" value="linux" />
          <param name="plugin.docker.pull.enabled" value="true" />
          <param name="plugin.docker.run.parameters" value="-v /var/run/docker.sock:/var/run/docker.sock -v $pwd:/app:ro -v $HOME/.docker:/root/.docker" />
          <param name="script.content"><![CDATA[set -xe
docker pull artifactory.guidewire.com/doctools-docker-dev/docportal:v%env.TAG_VERSION%
docker tag artifactory.guidewire.com/doctools-docker-dev/docportal:v%env.TAG_VERSION% 710503867599.dkr.ecr.us-east-2.amazonaws.com/tenant-doctools-docportal:v%env.TAG_VERSION%
eval $(aws ecr get-login --no-include-email | sed 's|https://||')
docker push 710503867599.dkr.ecr.us-east-2.amazonaws.com/tenant-doctools-docportal:v%env.TAG_VERSION%]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="DocumentationTools_DocumentationPortal_vcsrootmasteronly" />
    </vcs-settings>
    <requirements />
    <build-triggers />
    <cleanup />
  </settings>
</build-type>

