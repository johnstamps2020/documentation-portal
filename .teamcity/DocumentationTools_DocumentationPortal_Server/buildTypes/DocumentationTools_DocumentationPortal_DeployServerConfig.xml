<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2018.1/project-config.xsd">
  <name>Deploy server config</name>
  <description />
  <settings>
    <options>
      <option name="cleanBuild" value="true" />
    </options>
    <parameters>
      <param name="env.DEPLOY_ENV" value="" spec="select label='Deployment environment' description='Select an environment on which you want deploy the config' display='prompt' data_1='dev' data_2='int' data_3='staging' data_4='prod'" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_1" name="Generate config file" type="simpleRunner">
        <parameters>
          <param name="plugin.docker.imageId" value="python:3.8-slim" />
          <param name="plugin.docker.imagePlatform" value="linux" />
          <param name="script.content"><![CDATA[#!/bin/bash
set -xe
cd apps/config_deployer
python main.py]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_2" name="Upload config to S3" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/bin/bash
set -xe

if [[ %env.DEPLOY_ENV% == "prod" ]]; then
  export AWS_ACCESS_KEY_ID="$ATMOS_PROD_AWS_ACCESS_KEY_ID"
  export AWS_SECRET_ACCESS_KEY="$ATMOS_PROD_AWS_SECRET_ACCESS_KEY"
  export AWS_DEFAULT_REGION="$ATMOS_PROD_AWS_DEFAULT_REGION"
else
  export AWS_ACCESS_KEY_ID="$ATMOS_DEV_AWS_ACCESS_KEY_ID"
  export AWS_SECRET_ACCESS_KEY="$ATMOS_DEV_AWS_SECRET_ACCESS_KEY"
  export AWS_DEFAULT_REGION="$ATMOS_DEV_AWS_DEFAULT_REGION"					
fi

aws s3 cp apps/config_deployer/out/config.json s3://tenant-doctools-%env.DEPLOY_ENV%-builds/portal-config/config.json]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="DocumentationTools_DocumentationPortal_vcsrootmasteronly" />
    </vcs-settings>
    <requirements />
    <build-triggers />
    <cleanup />
  </settings>
</build-type>

