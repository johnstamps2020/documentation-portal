<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2018.1/project-config.xsd">
  <name>Release New Version</name>
  <description>Publish a release to Artifactory Docker Registry</description>
  <settings>
    <options>
      <option name="cleanBuild" value="true" />
      <option name="maximumNumberOfBuilds" value="1" />
    </options>
    <parameters>
      <param name="semver-scope" value="patch" spec="select label='Version Scope' display='prompt' label_1='Patch' data_1='patch' label_2='Minor' data_2='minor' label_3='Major' data_3='major'" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_1" name="Bump And Tag Version" type="simpleRunner">
        <parameters>
          <param name="plugin.docker.imageId" value="artifactory.guidewire.com/devex-docker-dev/atmosdeploy:0.12.24" />
          <param name="plugin.docker.imagePlatform" value="linux" />
          <param name="plugin.docker.pull.enabled" value="true" />
          <param name="plugin.docker.run.parameters" value="-v /var/run/docker.sock:/var/run/docker.sock -v $pwd:/app:ro -v $HOME/.docker:/root/.docker" />
          <param name="script.content"><![CDATA[set -xe
git config --global user.email "doctools@guidewire.com"
git config --global user.name "sys-doc"
git fetch --tags

cd server/
export TAG_VERSION=$(npm version %semver-scope%)
git add .
git commit -m "push changes to ${TAG_VERSION}"
git tag -a ${TAG_VERSION} -m "create new %semver-scope% version ${TAG_VERSION}"
git push
git push --tags

docker build -t docportal .
docker tag docportal:latest artifactory.guidewire.com/doctools-docker-dev/docportal:${TAG_VERSION}
docker push artifactory.guidewire.com/doctools-docker-dev/docportal:${TAG_VERSION}]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="DocumentationTools_DocumentationPortal_vcsrootmasteronly" />
    </vcs-settings>
    <requirements />
    <build-triggers />
    <build-extensions>
      <extension id="BUILD_EXT_1" type="DockerSupport">
        <parameters>
          <param name="login2registry" value="PROJECT_EXT_155" />
          <param name="loginCheckbox" value="on" />
        </parameters>
      </extension>
      <extension id="BUILD_EXT_2" type="ssh-agent-build-feature">
        <parameters>
          <param name="teamcitySshKey" value="sys-doc.rsa" />
        </parameters>
      </extension>
    </build-extensions>
    <cleanup />
  </settings>
</build-type>

