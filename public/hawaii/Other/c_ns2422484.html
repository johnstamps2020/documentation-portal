
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:whc="http://www.oxygenxml.com/webhelp/components" xml:lang="en-us" lang="en-us">
    <head><link rel="shortcut icon" href="../oxygen-webhelp/template/resources/images/webpagelogo.ico"><!----></link><link rel="icon" href="../oxygen-webhelp/template/resources/images/webpagelogo.ico"><!----></link><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="A Distributed startable plugin runs on every server in a cluster. Guidewire strongly recommends that Distributed plugins save their current start/stop state in a database. Persisting the start/stop ..." /><meta charset="UTF-8" /><meta name="copyright" content="(C) Copyright 2019" /><meta name="DC.rights.owner" content="(C) Copyright 2019" /><meta name="DC.type" content="concept" /><meta name="DC.format" content="HTML5" /><meta name="DC.identifier" content="c_ns2422484" /><meta name="DC.language" content="en-US" /><title>Writing a distributed startable plugin</title><!--  Generated with Oxygen version 21.1, build number 2019083011.  --><meta name="wh-path2root" content="../" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/arial-webfont.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/sourcesanspro-regular.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/sourcesanspro-light-webfont.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/sourcesanspro-extralight-webfont.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/sourcesanspro-black-webfont.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/sourcesanspro-semibold-webfont.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/AvenirNextLTPro-Regular.woff" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/fonts/cour.woff2" as="font" /><link rel="preload" href="../oxygen-webhelp/template/resources/js/simplebar.js" as="script" /><link rel="preload" href="../oxygen-webhelp/template/resources/css/simplebar.min.css" as="style" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/dharmachakra.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/chevron-left.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/chevron-right.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/share-alt.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/print-solid.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/times.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/angle-double-left.svg" as="image" /><link rel="preload" href="../oxygen-webhelp/template/resources/images/note.svg" as="image" /><link rel="stylesheet" type="text/css" href="../oxygen-webhelp/lib/bootstrap/css/bootstrap.min.css?buildId=20191106" /><link rel="stylesheet" href="../oxygen-webhelp/lib/jquery-ui/jquery-ui.min.css?buildId=20191106" /><link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/topic-page.css?buildId=2019083011" /><script type="text/javascript" src="../oxygen-webhelp/lib/jquery/jquery-3.4.1.min.js?buildId=20191106"><!----></script><script data-main="../oxygen-webhelp/app/topic-page.js" src="../oxygen-webhelp/lib/requirejs/require.js"></script><link rel="preload" href="" as="document" /><link rel="preload" href="" as="document" /><link rel="stylesheet" type="text/css" href="../oxygen-webhelp/template/resources/css/Guidewire-whr.css?buildId=2019083011" /></head>
    
    <body id="c_ns2422484" class="wh_topic_page frmBody">
        <a href="#wh_topic_body" class="sr-only sr-only-focusable">Jump to main content</a>
        <!-- EXM-36950 - Expand the args.hdr parameter here -->
        
        
        
        <header class="navbar navbar-default wh_header navbar-fixed-top" id="affix1">
    <div class="container-fluid">
        <div class="wh_header_flex_container">
            <div class="wh_logo_and_publication_title_container">
                <div class="wh_logo_and_publication_title">
                    
                    <!--
                            This component will be generated when the next parameters are specified in the transformation scenario:
                            'webhelp.logo.image' and 'webhelp.logo.image.target.url'.
                            See: http://oxygenxml.com/doc/versions/17.1/ug-editor/#topics/dita_webhelp_output.html.
                    -->
                    <a href="../index.html" class=" wh_logo not-hidden-xs "><img src="../oxygen-webhelp/template/resources/images/Guidewire_mini_logo.jpg" alt="Hawaii Documentation Demo" /></a>
                    <div class=" wh_publication_title "><a href="../index.html"><span class="title">Hawaii Documentation Demo</span></a></div>
                    
                </div>
                
                <!-- The menu button for mobile devices is copied in the output only when the 'webhelp.show.top.menu' parameter is set to 'yes' -->
                
            </div>

            <div class="wh_top_menu_and_indexterms_link collapse navbar-collapse" id="wh_top_menu_and_indexterms_link">
                
				
                
                
            </div>
			<!-- <div class="publicationDropDown">This Publication</div> -->
			<div class=" wh_search_input "><form id="searchForm" method="get" role="search" action="../search.html"><div><input type="search" placeholder="Search " class="wh_search_textfield" id="textToSearch" name="searchQuery" aria-label="Search query" required="required" /><button type="submit" class="wh_search_button" aria-label="Search"><span>Search</span></button></div></form></div>
			<div id="userAccount">
			<span>
				<i class="fas fa-dharmachakra" id="bt_logIn"></i>
			</span>
            <!--<span id="accountInfo"></span>-->            
            <span class="dropdown" id="show_profile" style="display: none;">
                <button class="dropdown-toggle" type="button" data-toggle="dropdown">
                    <span class="fas fa-dharmachakra"></span></button>
                <ul class="dropdown-menu">
                    <li class="avatar_userName"></li>
                    <li class="divider" id="divider-admin"></li>
                    <li><a href="#" id="bt_editProfile">Edit</a></li>
                    <li><a href="#" id="bt_logOff">Logout</a></li>
                </ul>
            </span>
            
            </div>
			<!-- <div class="Login">
				<span>
				<i class="fas fa-dharmachakra" id="bt_logIn"></i>
			</span></div> -->
        </div>
    </div>
</header>
        
        <!--<whc:webhelp_search_input/>-->
        
        <div class="container-fluid">
            <div class="row navbar navbar-fixed-top" id="affix2">
                <nav class="wh_tools hidden-print">
                    <span class="openNav" type="button" aria-expanded="true"><i class="fas fa-bars"></i></span>
                    <div data-tooltip-position="bottom" class=" wh_breadcrumb "></div>
                    <div class="wh_right_tools hidden-sm hidden-xs">
                        <div class=" wh_navigation_links "><span id="topic_navigation_links_header" class="navheader"></span></div>
                        <button class="wh_hide_highlight" aria-label="Toggle search highlights" title="Toggle search highlights"></button>
                        <!--<whc:webhelp_expand_collapse_sections/>-->
                        <span class=" shareLink share "><a class="button fas fa-share-alt" data-sharer="email" data-title="" data-url="" data-subject="" data-to="" title="Share this page" aria-label="Share this page" href=""></a></span>
                        <!-- <whc:webhelp_pdf_link class="pdf"/> -->
                        <span class=" whPrintLink print "><button class="fas fa-print fa-1x" onClick="window.print()" title="Print this page" aria-label="Print this page"></button></span>
                    </div>
                </nav>
            </div>
            
            <div class="wh_content_area">
                <div class="row justify-content-lg-end">
                    
                    
                    <div id="wh_topic_body" class="col-lg-6 col-md-9 col-sm-9 col-xs-12"><!-- /*DOCS-323 WebHelp Feedback - Adjust column widths*/-->
                        <div class=" wh_topic_content body "><main role="main"><article role="article" aria-labelledby="c_ns2422484__ns2422484">

  <h1 class="title topictitle1" id="c_ns2422484__ns2422484">Writing a distributed startable plugin</h1>
  <div class="body conbody">
    <p class="p">A Distributed startable plugin runs on every server in a cluster. Guidewire strongly recommends that Distributed
      plugins save their current start/stop state in a database. Persisting the start/stop state enables the plugin to
      handle edge cases, such as a server joining the cluster after other servers have started. To keep the state
      consistent across all servers, the state must persist in the database. Custom code can be written to persist the
      plugin's start/stop state.</p>
    <p class="p">The events related to servers and startable plugins are described in the following scenarios.</p>
    <ol class="ol">
      <li class="li">The server starts. When the appropriate server run level is reached, the startable plugin's
          <span class="keyword apiname">start</span> method is invoked with the <span class="keyword parmname">serverStartup</span> argument set to
          <code class="ph codeph">true</code>.</li>
      <li class="li">Operations enacted through the user interface or an invoked API can result in a request being sent to a server
        to start or stop a particular startable plugin. The server processes the request by calling the plugin's
          <span class="keyword apiname">start</span> or <span class="keyword apiname">stop</span> method. In these cases, the <span class="keyword apiname">start</span>
        method's <span class="keyword parmname">serverStartup</span> argument is set to <code class="ph codeph">false</code>. Similarly, the
          <span class="keyword apiname">stop</span> method's <span class="keyword parmname">serverStopping</span> argument is also set to
          <code class="ph codeph">false</code>.</li>

      <li class="li">The server shuts down. The startable plugin's <span class="keyword apiname">stop</span> method is invoked with the
          <span class="keyword parmname">serverStopping</span> argument set to <code class="ph codeph">true</code>.</li>
    </ol>
    <p class="p">The plugin's <span class="keyword apiname">start</span> method accepts a handler argument of the type
        <code class="ph codeph">StartablePluginCallbackHandler</code>. The methods implemented in the handler manage the database
      state information.</p>
    <ul class="ul">
      <li class="li"><code class="ph codeph">getState</code> – Retrieves the current start/stop state from the database. Returns
          <code class="ph codeph">true</code> if the server has started, otherwise <code class="ph codeph">false</code>. The first time the plugin
        is run on a server, the database state field does not yet exist. To handle this situation, the method accepts a
        single argument that specifies the default state to use to initialize the field. If the database field has been
        set by earlier operations, the argument is ignored.</li>
      <li class="li"><code class="ph codeph">setState</code> – Sets the plugin's start/stop state in the database. The method accepts a single
        argument that specifies the current state: <code class="ph codeph">true</code> if running, otherwise
        <code class="ph codeph">false</code>.</li>
      <li class="li"><code class="ph codeph">logStart</code> – Logs the event of starting the plugin. The method accepts a single argument that
        specifies the text describing the event.</li>
      <li class="li"><code class="ph codeph">logStop</code> – Logs the event of stopping the plugin. The method accepts a single argument that
        specifies the text describing the event.</li>
    </ul>

    <p class="p">The following Gosu example code implements <span class="keyword apiname">start</span> and <span class="keyword apiname">stop</span> methods for a
      Distributed startable plugin. It creates a trivial thread and maintains the plugin's start/stop state.</p>
    <pre class="pre codeblock"><code>package gw.api.startableplugin
uses gw.api.startable.IStartablePlugin
uses gw.api.startable.StartablePluginCallbackHandler
uses gw.api.startable.StartablePluginState
uses gw.transaction.Transaction
uses java.lang.Thread

@Distributed
class HelloWorldDistributedStartablePlugin implements IStartablePlugin {
  var _state : StartablePluginState
  var _startedHowManyTimes  = 0
  var _callback : StartablePluginCallbackHandler
  var _thread : Thread

  override property get State() : StartablePluginState  {
    return _state
  }

  override function start(handler : StartablePluginCallbackHandler,
                          serverStartup : boolean) : void {
    // Save the callback handler
    _callback = handler

    // Is server starting?
    if (serverStartup) {
      // Plugin is starting, too
      _state = _callback.getState(Started)

      // Log event
      if (_state == Started) {
        _callback.logStart("HelloWorldDistributedStartablePlugin:Started")
      } else {
        _callback.logStart("HelloWorldDistributedStartablePlugin:Stopped")
      }
    } else {
      // Plugin start/stop state has changed
      _state = Started
      if (_callback.State != Started) {
        changeState(Started)  // Update saved start/stop state
      }
      _callback.logStart("HelloWorldDistributedStartablePlugin")
    }
     
    // If thread already exists, stop it before restarting it
    if (_state == Started) and (_thread != null) {
        _thread.stop()
    }

    // Increment local counter
    _startedHowManyTimes++

    // Create and start thread
    var t = new Thread() {
      function run() {
        print("hello!")
      }
      t.Daemon=true
    }
  }

  override function stop(serverStopping : boolean) : void {
    // Stop thread
    if (_thread != null) {
      _thread.stop()
      _thread = null
    }

    if (_callback != null) {
      if (serverStopping) {
        if (_state == Started) {
          _callback.logStop("HelloWorldDistributedStartablePlugin:Started")
        } else {
          _callback.logStop("HelloWorldDistributedStartablePlugin:Stopped")
        }
        _callback = null
      } else {
        if (_callback.State != Stopped) {
          changeState(Stopped) // Update saved start/stop state
        }
        _callback.logStop("HelloWorldDistributedStartablePlugin")
      }
    }
    _state = Stopped
  }

  // Internal function to set the database state. If an exception occurs, retries 5 times.
  private function changeState(newState : StartablePluginState) {
    var tryCount = 0
    while (_callback.State != newState &amp;&amp; tryCount &lt; 5) {
      try {
        Transaction.runWithNewBundle(\ bundle -&gt; { _callback.setState(bundle, newState)},
              User.util.UnrestrictedUser)
      }
      catch (e : java.lang.Exception) {
        tryCount++
        _callback.log(this.IntrinsicType.Name + " on attempt " + tryCount +
               " caught " + (typeof e).Name + ": " + e.Message)
      }
    }
  }
}</code></pre>
  </div>
</article></main></div>
                        
                        
                        
                    </div>
                    
                        <nav role="navigation" id="wh_topic_toc" class="col-lg-2 hidden-sm hidden-xs navbar hidden-print"> <!-- /*DOCS-323 WebHelp Feedback - Adjust column widths*/-->
                            <div></div>
                        </nav>
                    
                </div>
            </div>
        </div> 
        <nav class="navbar navbar-default wh_footer navbar-bottom">
  <div class=" footer-container text-center ">
    <p><span class="footercopyright">© 2019 Guidewire Software, Inc.</span><span class="footerDate">Published November 20, 2019</span></p>
  </div>
</nav>
        
        <div id="go2top">
            <span class="glyphicon glyphicon-chevron-up"></span>
        </div>
        
        <!-- The modal container for images -->
        <div id="modal_img_large" class="modal">
            <span class="close glyphicon glyphicon-remove"></span>
            <!-- Modal Content (The Image) -->
            <img class="modal-content" id="modal-img" />
            <!-- Modal Caption (Image Text) -->
            <div id="caption"></div>
        </div>
        
        <!-- <script src="${oxygen-webhelp-assets-dir}/lib/bootstrap/js/bootstrap.min.js" type="text/javascript"></script> -->
        
    </body>
</html>