# Set up the security plugin

This works in tandem with out doc portal config for the doc. When set correctly,
the site build will generate two versions of the static site, each saved in a
separate subfolder.

- `__public`: the public version of the site. This is the default version that
  users see without logging in. They cannot access any restricted content.
- `__restricted`: users need to log in to see this version of the site. It
  includes all the public content plus any restricted content.

## Setup

Set your access to the `@doctools` scope in Artifactory: see
[Getting started](../../intro.mdx)

## Install

import ThemeCodeBlock from '@site/src/components/InstallationCodeBlock.tsx';

<ThemeCodeBlock packageName="docusaurus-security" />

## Configuration

1.  Add the plugin to your `docusaurus.config.js`.

    ```js
    plugins: [
      [
        "@doctools/docusaurus-security",
      ],
    ],
    ```

1.  In your `sidebars.ts`, import and use the `filterSidebarsByAccess` function.

    ```js
    import type { SidebarsConfig } from '@docusaurus/plugin-content-docs';
    import { filterSidebarsByAccess } from '@doctools/docusaurus-security';
    import { resolve } from 'path';

    const sidebars: SidebarsConfig = {
      mainSidebar: [
        // NOTE: Autogenerated sidebars are NOT supported
      ],
      userSidebar: [],
      someOtherSidebar: [],
    };

    const filteredSidebars = filterSidebarsByAccess(
      sidebars,
      resolve(__dirname, 'docs')
    );

    export default filteredSidebars;
    ```

    As the second argument to `filterSidebarsByAccess`, pass the path to the
    directory containing your docs.

1.  In your `package.json`, replace the `build` script with the following:

    ```json
    {
      "scripts": {
        "build": "docusaurus build-variants"
      }
    }
    ```

    The `build-variants` command is a custom command that we added to the
    Docusaurus CLI. It builds the site twice, once for the public version and
    once for the restricted version.

1.  In your doc config on the `documentation-portal`, set
    `ignorePublicPropertyAndUseVariants` to `true`.

    ```json
    {
      "ignorePublicPropertyAndUseVariants": true
    }
    ```

If you don't know what that means, contact us. We're happy to help. You can
reach us:

import ContactInfo from '@site/docs/_contact-info.mdx';

<ContactInfo />

## Testing locally

To test the restricted version of the site locally, run the following command:

```sh
BUILD_VARIANTS=true yarn build
```

This created two output directories:

- `build/__public`
- `build/__restricted`

To view the restricted version of the site, run the following command:

```sh
yarn serve --dir build/__restricted
```

Smililarly, to view the public version of the site, run the following command:

```sh
yarn serve --dir build/__public
```
