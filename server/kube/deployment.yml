apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: docportal-app-secret-store
  namespace: doctools
spec:
  retrySettings:
    maxRetries: 5
    retryInterval: \"10s\"
  provider:
    aws:
      role: arn:aws:iam::627188849628:role/aws_gwre-ccs-dev_tenant_doctools_developer
      service: SecretsManager
      region: us-west-2
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: docportal-app-external-secret
  namespace: doctools
spec:
  secretStoreRef:
    name: docportal-app-secret-store
    kind: SecretStore
  target:
    name: docportal-app-external-secret
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: tenant-doctools-docportal
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: docportal-app-pdb
  namespace: doctools
  labels:
    app: docportal-app
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: docportal-app
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: docportal-app-deployment
  namespace: doctools
  labels:
    tags.datadoghq.com/env: atmos-${DEPLOY_ENV}
    tags.datadoghq.com/service: docportal
    tags.datadoghq.com/version: ${TAG_VERSION}
    app: docportal-app
    app.kubernetes.io/name: expressjs
    app.kubernetes.io/version: ${TAG_VERSION}
    app.kubernetes.io/component: web-app
    app.kubernetes.io/part-of: docportal-app
    app.kubernetes.io/managed-by: doctools
    app.kubernetes.io/created-by: doctools
    atmos.guidewire.com/tenancy-scope: shared
spec:
  selector:
    matchLabels:
      app: docportal-app
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
  template:
    metadata:
      name: docportal-app-deployment
      namespace: doctools
      labels:
        tags.datadoghq.com/env: atmos-${DEPLOY_ENV}
        tags.datadoghq.com/service: docportal
        tags.datadoghq.com/version: ${TAG_VERSION}
        app: docportal-app
        app.kubernetes.io/name: expressjs
        app.kubernetes.io/version: ${TAG_VERSION}
        app.kubernetes.io/component: web-app
        app.kubernetes.io/part-of: docportal-app
        app.kubernetes.io/managed-by: doctools
        app.kubernetes.io/created-by: doctools
        atmos.guidewire.com/tenancy-scope: shared
      annotations:
        iam.amazonaws.com/role: arn:aws:iam::627188849628:role/aws_gwre-ccs-dev_tenant_doctools_developer
    spec:
      containers:
        - name: docportal
          image: artifactory.guidewire.com/doctools-docker-dev/docportal:${TAG_VERSION}
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - '30'
          command: [ \"/bin/sh\", \"-c\" ]
          args: [ \"until wget -qO- http://127.0.0.1:15000/server_info | grep '\\\"state\\\": \\\"LIVE\\\"'; do echo 'Waiting for Istio sidecar'; sleep 1 ; done ; echo 'istio sidecar available'; node server.js\" ]
          imagePullPolicy: Always
          ports:
            - containerPort: 8081
          livenessProbe:
            httpGet:
              path: /alive
              port: 8081
            initialDelaySeconds: 60
            periodSeconds: 45
          readinessProbe:
            httpGet:
              path: /alive
              port: 8081
            initialDelaySeconds: 150
            periodSeconds: 45
          env:
            - name: REFRESH_IMAGE
              value: 'BUILD_TIME'
            - name: OKTA_DOMAIN
              value: ${OKTA_DOMAIN}
            - name: OKTA_IDP
              value: ${OKTA_IDP}
            - name: OKTA_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: okta_client_id
            - name: OKTA_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: okta_client_secret
            - name: OKTA_ACCESS_TOKEN_ISSUER
              value: ${OKTA_ACCESS_TOKEN_ISSUER}
            - name: OKTA_ACCESS_TOKEN_SCOPES
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: okta_access_token_scopes
            - name: OKTA_ACCESS_TOKEN_AUDIENCE
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: okta_access_token_audience
            - name: APP_BASE_URL
              value: https://docs.${DEPLOY_ENV}.ccs.guidewire.net
            - name: SESSION_KEY
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: session_key
            - name: ELASTIC_SEARCH_URL
              value: http://docsearch-${DEPLOY_ENV}.doctools:9200
            - name: DOC_S3_URL
              value: https://ditaot.internal.${DEPLOY_ENV}.ccs.guidewire.net
            - name: PORTAL2_S3_URL
              value: https://portal2.internal.us-east-2.service.guidewire.net
            - name: PARTNERS_LOGIN_URL
              value: ${PARTNERS_LOGIN_URL}
            - name: PARTNERS_LOGIN_CERT
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: partners_login_cert
            - name: PARTNERS_LOGIN_SERVICE_PROVIDER_ENTITY_ID
              value: https://docs.${DEPLOY_ENV}.ccs.guidewire.net/partners-login
            - name: CUSTOMERS_LOGIN_URL
              value: ${CUSTOMERS_LOGIN_URL}
            - name: CUSTOMERS_LOGIN_CERT
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: customers_login_cert
            - name: CUSTOMERS_LOGIN_SERVICE_PROVIDER_ENTITY_ID
              value: https://docs.${DEPLOY_ENV}.ccs.guidewire.net/customers-login
            - name: ALLOW_PUBLIC_DOCS
              value: 'yes'
            - name: ENABLE_AUTH
              value: 'yes'
            - name: JIRA_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: docportal-app-external-secret
                  key: jira_auth_token
            - name: DD_ENV
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['tags.datadoghq.com/env']
            - name: DD_SERVICE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['tags.datadoghq.com/service']
            - name: DD_VERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['tags.datadoghq.com/version']
            - name: DD_HTTP_CLIENT_TAG_QUERY_STRING
              value: 'true'
            - name: DD_HTTP_SERVER_TAG_QUERY_STRING
              value: 'true'
            - name: DD_SERVICE_MAPPING
              value: "nodejs:atmos-${DEPLOY_ENV}-docportal-app"
            - name: DD_LOGS_INJECTION
              value: 'true'
            - name: DD_PROFILING_ENABLED
              value: 'true'
            - name: DD_TAGS
              value: layer:webapp, team:doctools
            - name: DD_TRACE_ANALYTICS_ENABLED
              value: 'true'
            - name: DD_TRACE_STARTUP_LOGS
              value: 'true'
            - name: DD_AGENT_HOST
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: DD_PROPAGATION_STYLE_INJECT
              value: "Datadog,B3"
          resources:
            requests:
              memory: \"4G\"
              cpu: \"1\"
            limits:
              memory: \"8G\"
              cpu: \"2\"
      imagePullSecrets:
        - name: artifactory-secret